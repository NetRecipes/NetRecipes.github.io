<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
  function getMermaidTheme() {
    // Check multiple sources for theme
    const storedTheme = localStorage.getItem('pref-theme');
    const hasDataTheme = document.documentElement.getAttribute('data-theme');
    const bodyHasDark = document.body.classList.contains('dark');
    const htmlHasDark = document.documentElement.classList.contains('dark');
    
    console.log('Theme detection:', {
      storedTheme,
      hasDataTheme,
      bodyHasDark,
      htmlHasDark
    });
    
    const isDark = storedTheme === 'dark' || 
                   hasDataTheme === 'dark' || 
                   bodyHasDark || 
                   htmlHasDark;
    
    return isDark ? 'dark' : 'default';
  }

  function initMermaid() {
    // Convert code blocks to mermaid divs
    document.querySelectorAll('pre code.language-mermaid, pre > code[class*="language-mermaid"]').forEach(function(code) {
      const pre = code.parentElement;
      const div = document.createElement('div');
      div.className = 'mermaid';
      div.textContent = code.textContent;
      pre.replaceWith(div);
    });
    
    const currentTheme = getMermaidTheme();
    console.log('Using mermaid theme:', currentTheme);
    
    mermaid.initialize({ 
      startOnLoad: false,
      theme: currentTheme
    });
    
    mermaid.run({
      querySelector: '.mermaid'
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMermaid);
  } else {
    initMermaid();
  }

  // Watch for theme changes on multiple elements
  const themeObserver = new MutationObserver(function(mutations) {
    for (let mutation of mutations) {
      if (mutation.type === 'attributes' && 
          (mutation.attributeName === 'class' || mutation.attributeName === 'data-theme')) {
        setTimeout(() => location.reload(), 100);
        break;
      }
    }
  });
  
  themeObserver.observe(document.body, { attributes: true });
  themeObserver.observe(document.documentElement, { attributes: true });
</script>